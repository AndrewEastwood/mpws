{$_widgetName = "CustomMonitor"}
{$_resourceOwner = "customMonitor"}

<div id="MPWSWidget{$_resourceOwner|capitalize}ID" class="MPWSWidget MPWSWidgetCustom MPWSWidget{$_widgetName} MPWSWidget{$_resourceOwner|capitalize}">

    {* list of all reports *}
    <div class="MPWSBlock MPWSBlockAllReportLinks">
        {foreach $CURRENT.SOURCE.DATA.RECORD as $idx => $entry}
            {* show report owner *}
        <ul class="MPWSList">
            <li class="MPWSListItem">
            {include file=$CURRENT.OBJECT->objectTemplatePath_trigger_control
                _type='mpwsLinkAction'
                _name=$entry.ExternalKey
                _controlOwner=$_widgetName
                _action="ShowReport_`$entry.ID`"
                _resourceOwner=$_resourceOwner
                _href="javascript://"
                _single=true
                _useValueAsTitle=$entry.Name
                _mode='system'}
            {* show report scripts *}
            {if not empty($entry.Reports)}
                <ul class="MPWSList MPWSListSub">
                {$_scriptList = explode(';', trim($entry.Reports, ';'))}
                {foreach $_scriptList as $scriptName}
                    <li class="MPWSListItem">
                    {include file=$CURRENT.OBJECT->objectTemplatePath_trigger_control
                        _type='mpwsLinkAction'
                        _name=$scriptName
                        _controlOwner=$_widgetName
                        _action="render"
                        _oid=$entry.ID
                        _resourceOwner=$_resourceOwner
                        _single=true
                        _href='javascript://'
                        _useValueAsTitle=$scriptName
                        _customParams=['script'=>$scriptName]
                        _mpwsParams=['caller'=>'reporting','realm'=>'plugin']
                        _mode='system'}
                    </li>
                {/foreach}
                </li>
            {/if}
            </li>
        </ul>
        {/foreach}
    </div>

    {* injection placeholder *}
    <div id="MPWSBlockReportInjectionAreaUIID"></div>
    
    {* setup script holder *}
    <script id="MPWSBlockReportInjectionAreaScriptID"></script>

    <script>
        $('.MPWSBlockAllReportLinks .MPWSListSub a').click(function() {
            
            var _mpws_caller = $(this).attr('mpws-caller');
            var _mpws_oid = $(this).attr('mpws-oid');
            var _mpws_realm = $(this).attr('mpws-realm');
            
            mpws.api.objectRequest(this, function(data) {
                //mpws.tools.log(data);
                // inject report
                mpws.module.get('visualReport').setup(
                    'MPWSBlockReportInjectionAreaUIID',
                    'MPWSBlockReportInjectionAreaScriptID',
                    data.UI,
                    data.SCRIPT,
                    callbackSetup
                );
                // do setup callback
                function callbackSetup(init) {
                    customReportScriptSetup(
                        init, 
                        {
                            caller: _mpws_caller,
                            fn: 'fetchdata',
                            oid: _mpws_oid,
                            realm: _mpws_realm
                        }
                    );
                }
            }, true);
        });
    </script>

</div>