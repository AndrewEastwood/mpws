{$_controlOwner = 'RTEWH'}
{$_controlCssName = 'RichTextEditWithHightlight'}
{$_controlUseForm = $_useForm|default:false}
{$_controlSources = $_sources|default:[]}
{$_controlNameData = "mpws_field_`$_name|lower`_data"}
{$_controlNameSource = "mpws_field_`$_name|lower`_source"}

{if not empty($_jslib)}
{include file=$CURRENT.OBJECT->objectTemplatePath_simple_script
    _link=$_jslib}
{/if}

{* setup requested WYSIWYG *}
{if $_type eq 'ACE'}
    {* control content *}
    {capture name="controlBody"}
        {$uuid = md5(time())}
        {$controlID = "MPWSControlUUID_`$uuid`_ID"}
        <input type="hidden" id="{$controlID}" name="{$_controlNameData}" value="{htmlentities($_value)}"/>
        {if not empty($_controlSources)}
            <input type="hidden" name="{$_controlNameSource}" value="{$_controlSources}"/>
        {/if}
        {if $_useDivWrapper }
            <div id="MPWSWrapperRTEWH_{$_name|lower}_ID" class="MPWSWrapper MPWSWrapperRTEWH">{$_value}</div>
            {* TODO: move into default *}
            <style type="text/css" media="screen">
                .MPWSBockReportScriptEditArea .MPWSWrapperRTEWH { 
                    position: relative;
                    width: 100%;
                    height: 400px;
                    font-size: 16px;
                }
            </style>
            {$jsControlName = "\"MPWSWrapperRTEWH_`$_name|lower`_ID\""}
            <script>
                /* standart setup */
                var editor = ace.edit({$jsControlName});
                editor.setTheme("ace/theme/monokai");
                editor.getSession().setMode("ace/mode/javascript");
                editor.getSession().setUseWrapMode(true);
                /* custom handler */
                editor.getSession().on('change', function(e) {
                    $('#{$controlID}').val(editor.getSession().getValue());
                });
            </script>
        {else}
            {include file=$CURRENT.OBJECT->objectTemplatePath_control_htmlTextArea 
                _name=$_name
                _cols=$_cols|default:null
                _rows=$_rows|default:null
                _renderMode=$_renderMode|default:'normal'
                _value=$_value}
        {/if}
    {/capture}
    {* buttons *}
    {capture name="controlButtons"}
        {include file=$CURRENT.OBJECT->objectTemplatePath_control_mpwsFormButtons _buttons=['Save', 'Cancel'] _controlOwner=$_controlOwner _resourceOwner='control'}
    {/capture}

{/if}

{* render control *}

<div class="MPWSControlField MPWSControlField{$_controlCssName}">
{if $_controlUseForm }
    {$formID = "MPWSFromUUID_`$uuid`_ID"}
    <form action="" method="POST" id="{$formID}" class="MPWSForm">
        <div class="MPWSFormHeader">{$smarty.capture.controlButtons}</div>
        <div class="MPWSFormBody">{$smarty.capture.controlBody}</div>
        <div class="MPWSFormFooter">{$smarty.capture.controlButtons}</div>
    </form>
{else}
    {$smarty.capture.controlButtons}
    {$smarty.capture.controlBody}
    {$smarty.capture.controlButtons}
{/if}
</div>