<?php
namespace web\plugin\shop\api;

use \engine\objects\plugin as basePlugin;
use \engine\lib\validate as Validate;
use \engine\lib\secure as Secure;
use \engine\lib\path as Path;
use \engine\lib\request as Request;
use \engine\lib\utils as Utils;
use Exception;
use ArrayObject;

class catalog extends \engine\objects\api {

    private function getCategoriesFromCategoryTree ($categoryTree, $selectedCategoryID, &$list = array(), $inSelectedNode = false) {
        foreach ($categoryTree as $key => $node) {
            $this->getCategoriesFromCategoryTree($node['childNodes'], $selectedCategoryID, $list, $key === $selectedCategoryID);
            if ($inSelectedNode || $key === $selectedCategoryID) {
                $list[] = $key;
            }
        }
        return $list;
    }

    public function getCatalogBrowse () {

        $data = array();
        $categoryID = Request::fromGET('id', null);

        if (!is_numeric($categoryID)) {
            $data['error'] = '"id" parameter is missed';
            return $data;
        }

        $categoryID = intval($categoryID);

        $filterOptions = array(
            /* common options */
            "filter_viewSortBy" => null,
            "filter_viewItemsOnPage" => 16,
            "filter_viewPageNum" => 1,
            "filter_commonPriceMax" => null,
            "filter_commonPriceMin" => 0,
            "filter_commonStatus" => array(),
            "filter_commonFeatures" => array(),

            /* category based */
            "filter_categoryBrands" => array(),
            "filter_categorySubCategories" => array()
        );

        // filtering
        $filterOptionsApplied = new ArrayObject($filterOptions);
        $filterOptionsAvailable = new ArrayObject($filterOptions);

        // get all product available statuses
        $filterOptionsAvailable['filter_commonStatus'] = $this->getAPI()->products->getProductStatuses();

        // init filter
        foreach ($filterOptionsApplied as $key => $value) {
            $filterOptionsApplied[$key] = Request::fromGET($key, $filterOptions[$key]);
            if ($key == "filter_viewItemsOnPage" || $key == "filter_viewPageNum")
                $filterOptionsApplied[$key] = intval($filterOptionsApplied[$key]);
            if ($key === "filter_commonPriceMax" || $key == "filter_commonPriceMin")
                $filterOptionsApplied[$key] = floatval($filterOptionsApplied[$key]);
            if (is_string($filterOptionsApplied[$key])) {
                if ($key == "filter_commonStatus" || $key == "filter_categoryBrands")
                    $filterOptionsApplied[$key] = explode(',', $filterOptionsApplied[$key]);
                if ($key == "filter_categorySubCategories" || $key == "filter_commonFeatures") {
                    $IDs = explode(',', $filterOptionsApplied[$key]);
                    $filterOptionsApplied[$key] = array();
                    foreach ($IDs as $filterOptionID) {
                        $filterOptionsApplied[$key][] = intval($filterOptionID);
                    }
                }
            }
            // var_dump($filterOptionsApplied[$key]);
        }

        $filterOptionsApplied["id"] = $categoryID;
        $filterOptionsAvailable["id"] = $categoryID;

        // var_dump($filterOptionsApplied['filter_commonFeatures']);


        $activeTree = $this->getAPI()->categories->getCatalogTree();
        $cetegoriesIDs = $this->getCategoriesFromCategoryTree($activeTree, $categoryID);

        // var_dump($activeTree);
        var_dump($cetegoriesIDs);

        return;


        $dataConfigCategoryPriceEdges = $this->getPluginConfiguration()->data->jsapiShopCategoryPriceEdgesGet($categoryID);
        $dataConfigCategoryAllSubCategories = $this->getPluginConfiguration()->data->jsapiShopCategoryAllSubCategoriesGet($categoryID);

        // get category sub-categories and origins
        $dataCategoryPriceEdges = $this->getCustomer()->fetch($dataConfigCategoryPriceEdges);
        $dataCategoryAllSubCategories = $this->getCustomer()->fetch($dataConfigCategoryAllSubCategories);

        // var_dump($dataCategoryAllSubCategories);

        $cetagorySubIDs = array($categoryID);
        if (!empty($dataCategoryAllSubCategories))
            foreach ($dataCategoryAllSubCategories as $value)
                $cetagorySubIDs[] = $value['ID'];

        //filter: get category price edges
        $filterOptionsAvailable['filter_commonPriceMax'] = floatval($dataCategoryPriceEdges['PriceMax'] ?: 0) + 10;
        $filterOptionsAvailable['filter_commonPriceMin'] = floatval($dataCategoryPriceEdges['PriceMin'] ?: 0) - 10;
        if ($filterOptionsAvailable['filter_commonPriceMin'] < 0) {
            $filterOptionsAvailable['filter_commonPriceMin'] = 0;
        }

        // get all brands for both current category and sub-categories
        $dataConfigCategoryAllBrands = $this->getPluginConfiguration()->data->jsapiShopCategoryAndSubCategoriesAllBrandsGet(implode(',', $cetagorySubIDs));
        $dataCategoryAllBrands = $this->getCustomer()->fetch($dataConfigCategoryAllBrands);

        // set categories and brands
        $filterOptionsAvailable['filter_categoryBrands'] = $dataCategoryAllBrands ?: array();
        $filterOptionsAvailable['filter_categorySubCategories'] = $dataCategoryAllSubCategories ?: array();

        // set data source
        // ---
        $dataConfigProducts = $this->getPluginConfiguration()->data->jsapiGetShopCategoryProductList($cetagorySubIDs);

        // filter: display intems count
        if (!empty($filterOptionsApplied['filter_viewItemsOnPage']))
            $dataConfigProducts['limit'] = $filterOptionsApplied['filter_viewItemsOnPage'];
        else
            $filterOptionsApplied['filter_viewItemsOnPage'] = $dataConfigProducts['limit'];

        if (!empty($filterOptionsApplied['filter_viewPageNum']))
            $dataConfigProducts['offset'] = ($filterOptionsApplied['filter_viewPageNum'] - 1) * $dataConfigProducts['limit'];
        else
            $filterOptionsApplied['filter_viewPageNum'] = $filterOptionsAvailable['filter_viewPageNum'];

        // filter: items sorting
        $_filterSorting = explode('_', strtolower($filterOptionsApplied['filter_viewSortBy']));
        if (count($_filterSorting) === 2 && !empty($_filterSorting[0]) && ($_filterSorting[1] === 'asc' || $_filterSorting[1] === 'desc'))
            $dataConfigProducts['order'] = array('field' => $dataConfigProducts['source'] . '.' . ucfirst($_filterSorting[0]), 'ordering' => strtoupper($_filterSorting[1]));
        else
            $filterOptionsApplied['filter_viewSortBy'] = null;

        // filter: price 
        if ($filterOptionsApplied['filter_commonPriceMax'] > $filterOptionsApplied['filter_commonPriceMin'] && $filterOptionsApplied['filter_commonPriceMax'] <= $filterOptionsAvailable['filter_commonPriceMax'])
            $dataConfigProducts['condition']['Price'][] = $this->getPluginConfiguration()->data->jsapiCreateDataSourceCondition($filterOptionsApplied['filter_commonPriceMax'], '<=');
        else
            $filterOptionsApplied['filter_commonPriceMax'] = $filterOptionsAvailable['filter_commonPriceMax'];

        if ($filterOptionsApplied['filter_commonPriceMax'] > $filterOptionsApplied['filter_commonPriceMin'] && $filterOptionsApplied['filter_commonPriceMin'] >= $filterOptionsAvailable['filter_commonPriceMin'])
            $dataConfigProducts['condition']['Price'][] = $this->getPluginConfiguration()->data->jsapiCreateDataSourceCondition($filterOptionsApplied['filter_commonPriceMin'], '>=');
        else
            $filterOptionsApplied['filter_commonPriceMin'] = $filterOptionsAvailable['filter_commonPriceMin'];

        // var_dump($filterOptionsApplied);
        if (count($filterOptionsApplied['filter_commonFeatures']))
            $dataConfigProducts['condition']["FeatureID"] = $this->getPluginConfiguration()->data->jsapiCreateDataSourceCondition($filterOptionsApplied['filter_commonFeatures'], 'in');

        if (count($filterOptionsApplied['filter_commonStatus']))
            $dataConfigProducts['condition']["shop_products.Status"] = $this->getPluginConfiguration()->data->jsapiCreateDataSourceCondition($filterOptionsApplied['filter_commonStatus'], 'in');

        // filter: brands
        if (count($filterOptionsApplied['filter_categoryBrands']))
            $dataConfigProducts['condition']['OriginID'] = $this->getPluginConfiguration()->data->jsapiCreateDataSourceCondition($filterOptionsApplied['filter_categoryBrands'], 'in');

        // var_dump($dataConfigProducts);
        // get products
        $dataProducts = $this->getCustomer()->fetch($dataConfigProducts);
        // get category info according to product filter
        // if (isset($dataConfigProducts['condition']['Price']))
        //     $dataConfigCategoryInfo['condition']['Price'] = $dataConfigProducts['condition']['Price'];
        // // $dataConfigCategoryInfo['condition'] = new ArrayObject($dataConfigProducts['condition']);
        // $dataCategoryInfo = $this->getCustomer()->fetch($dataConfigCategoryInfo);

        // TODO smth with this
        $products = array();
        if (!empty($dataProducts))
            foreach ($dataProducts as $val)
                $products[] = $this->getAPI()->products->getProductByID($val['ID'], false, false);

        // $productsInfo = array();
        // if (!empty($dataCategoryInfo))
        //     foreach ($dataCategoryInfo as $val)
        //         $productsInfo[] = $this->getAPI()->products->getProductByID($val['ID'], false, false);

        // adjust brands, categories and features
        $brands = array();
        $categories = array();
        $statuses = array();//$this->getCustomerDataBase()->getTableStatusFieldOptions($this->getPluginConfiguration()->data->Table_ShopProducts);
        $features = array();
        foreach ($filterOptionsAvailable['filter_categoryBrands'] as $brand) {
            $count = 0;
            $dataConfigCategoryInfo = $this->getPluginConfiguration()->data->jsapiGetShopCategoryProductInfo($cetagorySubIDs);
            $dataConfigCategoryInfo['condition'] = new ArrayObject($dataConfigProducts['condition']);
            $dataConfigCategoryInfo['condition']['OriginID'] = $this->getPluginConfiguration()->data->jsapiCreateDataSourceCondition($brand['ID']);
            $filterData = $this->getCustomer()->fetch($dataConfigCategoryInfo);
            if (isset($filterData) && isset($filterData['ItemsCount'])) {
                $count = $filterData['ItemsCount'];
            }
            $brands[$brand['ID']] = $brand;
            $brands[$brand['ID']]['ProductCount'] = $count;
        }
        foreach ($filterOptionsAvailable['filter_categorySubCategories'] as $category) {
            $count = 0;
            $dataConfigCategoryInfo = $this->getPluginConfiguration()->data->jsapiGetShopCategoryProductInfo($cetagorySubIDs);
            $dataConfigCategoryInfo['condition'] = new ArrayObject($dataConfigProducts['condition']);
            $dataConfigCategoryInfo['condition']['CategoryID'] = $this->getPluginConfiguration()->data->jsapiCreateDataSourceCondition($category['ID']);
            $filterData = $this->getCustomer()->fetch($dataConfigCategoryInfo);
            if (isset($filterData) && isset($filterData['ItemsCount'])) {
                $count = $filterData['ItemsCount'];
            }
            $categories[$category['ID']] = $category;
            $categories[$category['ID']]['ProductCount'] = $count;
        }
        foreach ($filterOptionsAvailable['filter_commonStatus'] as $status) {
            $count = 0;
            $dataConfigCategoryInfo = $this->getPluginConfiguration()->data->jsapiGetShopCategoryProductInfo($cetagorySubIDs);
            $dataConfigCategoryInfo['condition'] = new ArrayObject($dataConfigProducts['condition']);
            $arrValues = array($status);
            if (!empty($filterOptionsApplied['filter_commonStatus'])) {
                $arrValues = array_merge($filterOptionsApplied['filter_commonStatus'], $arrValues);
            }
            // var_dump($arrValues);
            $dataConfigCategoryInfo['condition']['shop_products.Status'] = $this->getPluginConfiguration()->data->jsapiCreateDataSourceCondition($arrValues, 'IN');
            $filterData = $this->getCustomer()->fetch($dataConfigCategoryInfo);
            if (isset($filterData) && isset($filterData['ItemsCount'])) {
                $count = intval($filterData['ItemsCount']);
            }
            $statuses[$status]['ID'] = $status;
            $statuses[$status]['ProductCount'] = $count;
        }

        if ($products)
            foreach ($products as $obj) {
                $OriginID = $obj['OriginID'];
                $CategoryID = $obj['CategoryID'];
                $status = $obj['Status'];
                if (isset($statuses[$status]))
                    $statuses[$status]['ProductCount']++;
                if (isset($brands[$OriginID]))
                    $brands[$OriginID]['ProductCount']++;
                if (isset($categories[$CategoryID]))
                    $categories[$CategoryID]['ProductCount']++;
                foreach ($obj['Features'] as $featureGroup => $featureList) {
                    if (!isset($features[$featureGroup])) {
                        $features[$featureGroup] = array();
                    }
                    foreach ($featureList as $key => $featureName) {
                        if (!isset($features[$featureGroup][$key]['Count'])) {
                            $features[$featureGroup][$key] = array(
                                'Name' => $featureName,
                                'Count' => 1,
                                'ID' => $key
                            );
                        }
                        else {
                            // $features[$featureGroup][$key]['Name'] = $featureName
                            $features[$featureGroup][$key]['Count']++;
                            // $features[$featureGroup][$key]['ID'] = $featureID;
                        }
                    }
                }
            }

        $filterOptionsAvailable['filter_categoryBrands'] = $brands;
        $filterOptionsAvailable['filter_categorySubCategories'] = $categories;
        $filterOptionsAvailable['filter_commonStatus'] = $statuses;
        $filterOptionsAvailable['filter_commonFeatures'] = $features;

        // store data
        $data['items'] = $products;
        $data['filter'] = array(
            'filterOptionsAvailable' => $filterOptionsAvailable,
            'filterOptionsApplied' => $filterOptionsApplied,
            'info' => array(
                "count" => count($products),
                "cetagorySubIDs" => $cetagorySubIDs
            )
        );
        // return data object
        return $data;
    }

    public function get (&$resp, $req) {
        $resp = $this->getCatalogBrowse($req->data);
    }

}

?>